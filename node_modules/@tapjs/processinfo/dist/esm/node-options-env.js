import { argvToNodeOptions } from './argv-to-node-options.js';
import { legacyLoader, legacyMatch, importLoader, importMatch, } from './loader-paths.js';
import { nodeOptionsToArgv } from './node-options-to-argv.js';
import Module from 'node:module';
const getKeyValue = (args, i) => {
    const arg = args[i];
    /* c8 ignore start */
    if (typeof arg !== 'string')
        throw new Error('invalid arg');
    /* c8 ignore stop */
    if (arg.includes('=')) {
        const [k, ...rest] = arg.split('=');
        return [true, k, rest.join('=')];
    }
    else if (i < args.length - 1) {
        return [false, arg, args[i + 1]];
    }
    else {
        return [false, arg, undefined];
    }
};
const useImport = !!Module
    .register;
const addLoader = (args) => {
    const addKey = useImport ? '--import' : '--loader';
    const addValue = useImport ? importLoader : legacyLoader;
    const doNotWantKeys = [
        '--experimental-loader',
        useImport ? '--loader' : '--import',
    ];
    const test = useImport ? importMatch : legacyMatch;
    const added = [];
    let doubledash = false;
    let found = false;
    for (let i = 0; i < args.length; i++) {
        const arg = args[i];
        /* c8 ignore start */
        if (typeof arg !== 'string')
            throw new Error('invalid arg');
        /* c8 ignore stop */
        if (!arg.startsWith('--') || doubledash) {
            added.push(arg);
            continue;
        }
        if (arg === '--') {
            added.push(arg);
            doubledash = true;
            continue;
        }
        const [eq, k, v] = getKeyValue(args, i);
        if (!v) {
            // wasn't a key-value pair
            added.push(arg);
            continue;
        }
        if (!eq)
            i++;
        if (doNotWantKeys.includes(k) && (importMatch(v) || legacyMatch(v))) {
            // it's ours, but not how we want it, omit
            continue;
        }
        if (k === addKey && test(v)) {
            // already present, don't let it be set multiple times.
            if (found)
                continue;
            found = true;
            added.push(arg);
            const next = args[i];
            if (!eq && typeof next === 'string')
                added.push(next);
        }
        else {
            // not ours
            added.push(arg);
            const next = args[i];
            if (!eq && typeof next === 'string')
                added.push(next);
            continue;
        }
    }
    if (!found)
        added.push(`${addKey}=${addValue}`);
    return !useImport ? addIgnoreLoadersWarning(added) : added;
};
const addIgnoreLoadersWarning = (args) => args.includes('--no-warnings') ||
    args.includes('--no-warnings=ExperimentalLoader')
    ? args
    : args.concat('--no-warnings');
export const nodeOptionsEnv = (env) => {
    const no = nodeOptionsToArgv(env.NODE_OPTIONS);
    return argvToNodeOptions(addLoader(no));
};
//# sourceMappingURL=node-options-env.js.map